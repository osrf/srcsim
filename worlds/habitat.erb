<%
  # Template for habitat model for SRC finals world

  # Requires the following global variables:
  # $habitat_frame

  # Door frame in world coordinates
  door_offset_x = -6.68
  door_offset_y = -1.215
  door_frame = $habitat_frame * TMatrix(door_offset_x, door_offset_y, 0);
  door_pos_z = 2.28

  # Door dimensions
  door_col_size_x = 1.27
  door_col_size_y = 0.25
  door_col_size_z = 1.99

  door_vis_pos_x = 6.68
  door_vis_pos_y = -door_offset_y
  door_vis_pos_z = -door_pos_z - 0.6

  # Valve dimensions
  valve_pos_x = 0
  valve_pos_y = -0.12
  valve_pos_z = 0.08

%>

<!-- Base model - static frame -->

<model name="habitat_base">
  <static>true</static>

  <pose>
  <%= $habitat_frame[0, 2] %>
  <%= $habitat_frame[1, 2] %>
  0
  0
  0
  <%= Math::atan2($habitat_frame[1, 0], $habitat_frame[0, 0]) %>
  </pose>

  <link name="link_stairs">

    <%
      step_count = 7
      size_x = 2.46997
      size_y = 0.317063
      size_z = 0.210
      pos_x = -6.686
      for step in 0..step_count
        pos_y = -5.597 + 0.2389 * step
        pos_z = 0.1079 + 0.2031 * step
    %>

    <collision name="step_<%= step %>">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 0 0</pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <% end %>

    <%
      size_y = 2.95
      pos_y = pos_y + 1.555
      pos_z = pos_z + 0.1804
    %>

    <collision name="walkway">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 0 0</pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 2.46
      size_y = 0.055
      size_z = 0.034
      pos_x = -7.920
      pos_y = -4.838
      pos_z = 1.828
      pitch = -0.7133
      yaw = Math::PI / 2.0
    %>

    <collision name="rail_1_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.451
    %>

    <collision name="rail_1_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 2.52
      size_z = 0.037
      pos_x = -7.920
      pos_y = -4.678
      pos_z = 1.368
      pitch = -0.709
    %>

    <collision name="rail_2_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_2_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 1.96
      size_y = 0.055
      size_z = 0.048
      pos_x = -7.920
      pos_y = -2.13
      pos_z = 2.625
      pitch = 0
    %>

    <collision name="rail_3_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4305
    %>

    <collision name="rail_3_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -7.920
      pos_z = 2.153
    %>

    <collision name="rail_4_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4305
    %>

    <collision name="rail_4_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.16
      pos_x = -7.920
      pos_y = -3.64
    %>

    <collision name="rail_5_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_5_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.37
      pos_x = -7.920
      pos_y = -3.735
      pos_z = 2.625
    %>

    <collision name="rail_6_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_6_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.46
      pos_x = -7.920
      pos_y = -5.88
      pos_z = 0.555
    %>

    <collision name="rail_7_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_7_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.35
      pos_x = -7.920
      pos_y = -5.935
      pos_z = 1.027
    %>

    <collision name="rail_8_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_8_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.05
      size_z = 0.478
      pos_x = -7.920
      pos_y = -5.65
      pos_z = 0.335
    %>

    <collision name="rail_9_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_9_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.046
      size_z = 0.478
      pos_x = -7.920
      pos_y = -5.722
      pos_z = 0.795
      pitch = -0.325
    %>

    <collision name="rail_10_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_10_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.05
      size_z = 0.568
      pos_x = -7.920
      pos_y = -3.738
      pos_z = 1.89
      pitch = 0
    %>

    <collision name="rail_11_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_11_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_x = 0.046
      size_z = 0.478
      pos_x = -7.920
      pos_y = -3.81
      pos_z = 2.39
      pitch = -0.325
    %>

    <collision name="rail_12_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4505
    %>

    <collision name="rail_12_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      size_z = 1.028
      pos_x = -7.920
      pos_y = -2.842
      pos_z = 2.12
      pitch = 0
    %>

    <collision name="rail_13_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4305
    %>

    <collision name="rail_13_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -7.920
      pos_y = -1.595
    %>

    <collision name="rail_14_left">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <%
      pos_x = -5.4305
    %>

    <collision name="rail_14_right">
      <pose><%= pos_x %> <%= pos_y %> <%= pos_z %> 0 <%= pitch %> <%= yaw %></pose>
      <geometry>
        <box>
          <size><%= size_x %> <%= size_y %> <%= size_z %> </size>
        </box>
      </geometry>
    </collision>

    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Stairs</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <link name="link_module_long">
    <collision name="collision">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Module_Long</name>
          </submesh>
        </mesh>
      </geometry>
    </collision>
    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Module_Long</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <link name="link_door_04">
    <collision name="collision">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_04</name>
          </submesh>
        </mesh>
      </geometry>
    </collision>
    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_04</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <link name="link_module_large">
    <collision name="collision">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Module_Large</name>
          </submesh>
        </mesh>
      </geometry>
    </collision>
    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Module_Large</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <link name="link_door_01">
    <collision name="collision">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_01</name>
          </submesh>
        </mesh>
      </geometry>
    </collision>
    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_01</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <link name="door_03">
    <collision name="collision">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_03</name>
          </submesh>
        </mesh>
      </geometry>
    </collision>
    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_03</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <link name="module_small">
    <collision name="collision">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Module_Small</name>
          </submesh>
        </mesh>
      </geometry>
      <surface>
        <contact>
          <!-- Don't collide with door -->
          <collide_bitmask>0x01</collide_bitmask>
        </contact>
      </surface>
    </collision>
    <visual name="visual">
      <pose>0 0 0 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Module_Small</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>
</model>

<!-- Door -->
<model name="habitat_door">

  <pose>
    <%= door_frame[0, 2] %>
    <%= door_frame[1, 2] %>
    2.88
    0
    0
    <%= Math::atan2(door_frame[1, 0], door_frame[0, 0]) %>
  </pose>

  <!-- door body -->
  <link name="base">

    <inertial>
      <mass>18</mass>
      <inertia>
        <ixx>6.304</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>6.9932</iyy>
        <iyz>0</iyz>
        <izz>0.7979</izz>
      </inertia>
    </inertial>

    <collision name="collision">
      <geometry>
        <box>
          <size><%= door_col_size_x %> <%= door_col_size_y %> <%= door_col_size_z %></size>
        </box>
      </geometry>
      <surface>
        <contact>
          <!-- Don't collide with habitat -->
          <collide_bitmask>0x10</collide_bitmask>
        </contact>
      </surface>
    </collision>

    <visual name="visual">
      <pose><%= door_vis_pos_x %> <%= door_vis_pos_y %> <%= door_vis_pos_z %> 0 0 0</pose>
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/hdu.obj</uri>
          <scale>0.0254 0.0254 0.0254</scale>
          <submesh>
            <name>Door_02</name>
          </submesh>
        </mesh>
      </geometry>
    </visual>
  </link>

  <!-- door valve -->
  <link name="valve">
    <pose><%= valve_pos_x %> <%= valve_pos_y %> <%= valve_pos_z %> 0 0 3.14</pose>
    <inertial>
      <mass>7.8219</mass>
      <pose>0 0.0615 0 0 0 0</pose>
      <inertia>
        <ixx>0.0695</ixx>
        <ixy>0.0000</ixy>
        <ixz>0.0000</ixz>
        <iyy>0.1349</iyy>
        <iyz>0.0000</iyz>
        <izz>0.0695</izz>
      </inertia>
    </inertial>
    <collision name="collision">
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/wheel_valve_large.dae</uri>
        </mesh>
      </geometry>
      <surface>
        <friction>
          <ode>
            <mu>1</mu>
            <mu2>1</mu2>
          </ode>
        </friction>
        <contact>
          <ode>
            <kp>1000000.0</kp>
            <kd>100.0</kd>
            <max_vel>0.01</max_vel>
            <min_depth>0.001</min_depth>
          </ode>
        </contact>
      </surface>
    </collision>
    <visual name="visual">
      <geometry>
        <mesh>
          <uri>model://src_habitat/meshes/wheel_valve_large.dae</uri>
        </mesh>
      </geometry>
    </visual>
  </link>

  <!-- Joint connecting the valve and the door -->
  <joint name="valve_hinge" type="revolute">
    <parent>base</parent>
    <child>valve</child>
    <axis>
      <xyz>0 1 0</xyz>
      <limit>
        <lower>-12.5663706144</lower>
        <upper>0</upper>
      </limit>
      <dynamics>
        <damping>1.0</damping>
      </dynamics>
    </axis>
    <physics>
      <ode>
        <cfm_damping>1</cfm_damping>
      </ode>
    </physics>
  </joint>

  <!-- Door hinge -->
  <joint name="door_hinge" type="revolute">
    <parent>world</parent>
    <child>base</child>
    <pose>-0.8 <%= door_col_size_y * 0.5 %> 0.2 0 0 0</pose>
    <axis>
      <xyz>0 0 1</xyz>
      <limit>
        <lower>0</lower>
        <upper>1.57</upper>
      </limit>
      <dynamics>
        <damping>0</damping>
        <friction>0</friction>
      </dynamics>
    </axis>
    <physics>
      <ode>
        <cfm_damping>1</cfm_damping>
      </ode>
    </physics>
  </joint>
</model>




